<!DOCTYPE html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!--
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
-->
<style>
  * {font-family: sans-serif;}
  p, input, textarea, select, li, button {font-size: 110%}
  textarea {font-family: monospace; font-size: 120%}
</style>

<!--load scripts here-->
<script src="/xbrowser/module/xdev/xdev_b2.js"></script>
<script src="/xbrowser/library/md5/md5.min.js"></script>
</head>

<body>
<alert></alert>
<menu></menu>
<tool></tool>

<content>
  <h1>home</h1>
  <p>Status: <span id='status'>Inactive</span></p>
  Username <input id="user_name" type="text"><br>
  Password <input id="pass_word" type="password" onchange="XB.hash(this.value).then(h => userInfo.passwordHash = h).then(this.value = '')">
  <br><br>
  <button onclick="login()">Log in</button>
  
</content>


<script>
async function init() {
    if (!XB.secure.sessionId) {
        XB.secure.sessionId = XB.uuid()
        sessionStorage.setItem('sessionId', XB.secure.sessionId)
        
        if (!XB.ip) {
            XB.ip = await XB.getIp()
        } 
        let re = await XB.$({send:{act:'new_session'}})
        
        //certify the packet
        if (await XB.cert(re)) {
          //packet is certified

          //unwrap msg
          let msg = await XB.dec(re.msg, await XB.makeKey(re))
          //console.log(msg)

          if (XB.isJson(msg)) {
            msg = JSON.parse(msg)
          }

          //set values
          XB.active = re.active
          XB.el('#status').textContent = 'Active'
          XB.xserver.serverId = re.from
          XB.secure.salt = msg.yourNewSalt
          sessionStorage.setItem('active', true)
          sessionStorage.setItem('serverId', re.from)
          sessionStorage.setItem('salt', msg.yourNewSalt)

          console.log('everything done!')

        } else {
          console.log('the resp not certified')
        }
    
      } else {
        //has sessionId
        XB.active = true
        XB.secure.sessionId = sessionStorage.getItem('sessionId')
        XB.secure.serverId = sessionStorage.getItem('serverId')
        XB.secure.salt = sessionStorage.getItem('salt')
        XB.el('#status').textContent = 'Active'
    }
}
init()    

const userInfo = {
  username: '', passwordHash: ''
}

async function login() {
  userInfo.username = user_name.value,
  console.log(userInfo)
}


</script>
</body>
</html>
